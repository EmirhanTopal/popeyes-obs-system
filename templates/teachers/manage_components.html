{% extends "base.html" %}
{% load widget_tweaks %}
{% load static %}
{% load custom_tags %}

{% block title %}{{ course.code }} ‚Äî Not Giri≈üi{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/teacher/manage_components.css' %}">
<style>
  body { background:#f5f7fb; }
  .component-box{background:#fff;border:1px solid #e5e5e5;border-radius:8px;padding:16px;margin-bottom:15px;}
  .lo-box{background:#f9fafc;border:1px dashed #cfd4da;border-radius:6px;padding:10px;margin-top:10px;}
  .remove-btn{font-size:.8rem}
  .section-title{font-weight:700;color:#0d6efd}
</style>
{% endblock %}

{% block content %}

<div class="container py-4" style="max-width:900px;">

  <div class="card shadow-sm">
    <div class="card-header">
      <div class="fw-semibold">{{ course.code }} ‚Äî {{ course.name }}</div>
      <small class="text-muted">Deƒüerlendirme Bile≈üenlerini ve Program Output e≈ülemelerini y√∂net</small>
    
      <a href="{% url 'teachers:course_management' %}"
        class="btn btn-outline-secondary btn-sm mb-3"
        style="position:absolute; top:15px; right:15px;">
        ‚Üê Ders Listeme D√∂n
      </a>

    </div>

    <div class="card-body">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} mb-2">{{ message }}</div>
      {% endfor %}

      <form method="post">
        {% csrf_token %}

        <div id="componentContainer">
          {% for c in components %}
            <div class="component-box">
              <input type="hidden" name="component_id_{{ forloop.counter0 }}" value="{{ c.id }}">
              <div class="row g-2 align-items-center">
                <div class="col-md-6">
                  <select name="type[]" class="form-select" required>
                    <option value="">Bile≈üen Se√ß</option>
                    <option value="MIDTERM" {% if c.type == "MIDTERM" %}selected{% endif %}>Vize</option>
                    <option value="FINAL" {% if c.type == "FINAL" %}selected{% endif %}>Final</option>
                    <option value="ASSIGNMENT" {% if c.type == "ASSIGNMENT" %}selected{% endif %}>√ñdev</option>
                    <option value="PROJECT" {% if c.type == "PROJECT" %}selected{% endif %}>Proje</option>
                    <option value="QUIZ" {% if c.type == "QUIZ" %}selected{% endif %}>Quiz</option>
                    <option value="ATTENDANCE" {% if c.type == "ATTENDANCE" %}selected{% endif %}>Katƒ±lƒ±m</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <input type="number" name="weight[]" value="{{ c.weight }}" class="form-control" min="1" max="100" placeholder="Aƒüƒ±rlƒ±k (%)" required>
                </div>
                <div class="col-md-2 text-end">
                  <button type="button" class="btn btn-outline-danger btn-sm remove-btn">Sil</button>
                </div>
              </div>

              <div class="lo-box">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="m-0 section-title">Learning Outcomes</h6>
                  <button type="button" class="btn btn-outline-secondary btn-sm add-lo-btn">+ LO Ekle</button>
                </div>

                <div class="lo-container">
                  {% with rels=c.learning_relations.all %}
                    {% for r in rels %}
                      <div class="row g-2 align-items-center mb-2">
                        <div class="col-md-7">
                          <select name="relation_lo_{{ forloop.parentloop.counter0 }}[]" class="form-select" required>
                            <option value="">Learning Outcome Se√ß</option>
                            {% for lo in learning_outcomes %}
                              <option value="{{ lo.id }}" {% if lo.id == r.learning_outcome_id %}selected{% endif %}>
                                {{ lo.code }} ‚Äî {{ lo.description|truncatechars:60 }}
                              </option>
                            {% endfor %}
                          </select>
                        </div>
                        <div class="col-md-3">
                          <input type="number" name="relation_lw_{{ forloop.parentloop.counter0 }}[]" value="{{ r.weight }}" class="form-control" placeholder="%LO" min="0" max="100">
                        </div>
                        <div class="col-md-2 text-end">
                          <button type="button" class="btn btn-outline-danger btn-sm del-row">Sil</button>
                        </div>
                      </div>
                    {% endfor %}
                  {% endwith %}
                </div>
              </div>
            </div>
          {% empty %}
            <p class="text-muted">Hen√ºz bile≈üen eklenmemi≈ü. Yeni bile≈üen ekleyebilirsin.</p>
          {% endfor %}
        </div>

        <button type="button" id="addComponent" class="btn btn-dark btn-sm mb-4">+ Yeni Bile≈üen Ekle</button>

        <hr class="my-4">

        <!-- PROGRAM OUTPUT HESAPLAMA -->
        <div class="mb-2 d-flex justify-content-between align-items-center">
          <h5 class="section-title m-0">Program Output Hesapla (LO ‚Üí PO)</h5>
          <button type="button" id="addPoMap" class="btn btn-outline-primary btn-sm">+ Ekle</button>
        </div>

        <div id="poMapContainer" class="mb-3">
          {% for m in lo_po_maps %}
            <div class="row g-2 align-items-center mb-2">
              <div class="col-md-5">
                <select name="po_map_lo[]" class="form-select" required>
                  <option value="">Learning Outcome Se√ß</option>
                  {% for lo in learning_outcomes %}
                    <option value="{{ lo.id }}" {% if lo.id == m.learning_outcome_id %}selected{% endif %}>
                      {{ lo.code }} ‚Äî {{ lo.description|truncatechars:60 }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-2">
                <input type="number" name="po_map_w[]" value="{{ m.weight }}" class="form-control" placeholder="%LO‚ÜíPO" min="0" max="100">
              </div>
              <div class="col-md-4">
                <select name="po_map_po[]" class="form-select" required>
                  <option value="">Program Outcome Se√ß</option>
                  {% for po in program_outcomes %}
                    <option value="{{ po.id }}" {% if po.id == m.program_outcome_id %}selected{% endif %}>
                      {{ po.code }} ‚Äî {{ po.description|truncatechars:60 }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-1 text-end">
                <button type="button" class="btn btn-outline-danger btn-sm del-row">Sil</button>
              </div>
            </div>
          {% endfor %}
        </div>

        <button class="btn btn-primary w-100 py-2 fw-semibold">üíæ Kaydet</button>
      </form>
    </div>
  </div>
</div>

<script>
  // Yeni bile≈üen ekle
  document.getElementById("addComponent").addEventListener("click", () => {
    const container = document.getElementById("componentContainer");
    const idx = container.querySelectorAll(".component-box").length;

    const div = document.createElement("div");
    div.className = "component-box";
    div.innerHTML = `
      <input type="hidden" name="component_id_${idx}" value="">
      <div class="row g-2 align-items-center">
        <div class="col-md-6">
          <select name="type[]" class="form-select" required>
            <option value="">Bile≈üen Se√ß</option>
            <option value="MIDTERM">Vize</option>
            <option value="FINAL">Final</option>
            <option value="ASSIGNMENT">√ñdev</option>
            <option value="PROJECT">Proje</option>
            <option value="QUIZ">Quiz</option>
            <option value="ATTENDANCE">Katƒ±lƒ±m</option>
          </select>
        </div>
        <div class="col-md-4">
          <input type="number" name="weight[]" class="form-control" min="1" max="100" placeholder="Aƒüƒ±rlƒ±k (%)" required>
        </div>
        <div class="col-md-2 text-end">
          <button type="button" class="btn btn-outline-danger btn-sm remove-btn">Sil</button>
        </div>
      </div>

      <div class="lo-box mt-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="m-0 section-title">Learning Outcomes</h6>
          <button type="button" class="btn btn-outline-secondary btn-sm add-lo-btn">+ LO Ekle</button>
        </div>
        <div class="lo-container"></div>
      </div>`;
    container.appendChild(div);
  });

  // LO satƒ±rƒ± ekleme/silme & component silme
  document.addEventListener("click", (e) => {
    if (e.target.classList.contains("add-lo-btn")) {
      const box = e.target.closest(".component-box");
      const idx = Array.from(document.querySelectorAll(".component-box")).indexOf(box);
      const loContainer = box.querySelector(".lo-container");

      const row = document.createElement("div");
      row.className = "row g-2 align-items-center mb-2";
      row.innerHTML = `
        <div class="col-md-7">
          <select name="relation_lo_${idx}[]" class="form-select" required>
            <option value="">Learning Outcome Se√ß</option>
            {% for lo in learning_outcomes %}
              <option value="{{ lo.id }}">{{ lo.code }} ‚Äî {{ lo.description|truncatechars:60 }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <input type="number" name="relation_lw_${idx}[]" class="form-control" placeholder="%LO" min="0" max="100">
        </div>
        <div class="col-md-2 text-end">
          <button type="button" class="btn btn-outline-danger btn-sm del-row">Sil</button>
        </div>`;
      loContainer.appendChild(row);
    }

    if (e.target.classList.contains("remove-btn"))
      e.target.closest(".component-box").remove();

    if (e.target.classList.contains("del-row"))
      e.target.closest(".row").remove();
  });

  // PO map satƒ±rƒ± ekleme
  document.getElementById("addPoMap").addEventListener("click", () => {
    const wrap = document.getElementById("poMapContainer");
    const row = document.createElement("div");
    row.className = "row g-2 align-items-center mb-2";
    row.innerHTML = `
      <div class="col-md-5">
        <select name="po_map_lo[]" class="form-select" required>
          <option value="">Learning Outcome Se√ß</option>
          {% for lo in learning_outcomes %}
            <option value="{{ lo.id }}">{{ lo.code }} ‚Äî {{ lo.description|truncatechars:60 }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <input type="number" name="po_map_w[]" class="form-control" placeholder="%LO‚ÜíPO" min="0" max="100">
      </div>
      <div class="col-md-4">
        <select name="po_map_po[]" class="form-select" required>
          <option value="">Program Outcome Se√ß</option>
          {% for po in program_outcomes %}
            <option value="{{ po.id }}">{{ po.code }} ‚Äî {{ po.description|truncatechars:60 }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-1 text-end">
        <button type="button" class="btn btn-outline-danger btn-sm del-row">Sil</button>
      </div>`;
    wrap.appendChild(row);
  });
</script>

{% endblock %}
