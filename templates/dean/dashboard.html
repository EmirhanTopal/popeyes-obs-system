# dean/views.py
from django.shortcuts import render, redirect
from django.contrib import messages
from django.contrib.auth.decorators import login_required, user_passes_test

from department.models import Department
from course.models import Course
from teacher.models import Teacher
from student.models import Student

from .forms import DepartmentForm, CourseForm, TeacherForm, StudentForm


def is_dean(user):
    """Sadece dekan rolüne erişim izni ver."""
    return hasattr(user, 'dean')


@login_required
@user_passes_test(is_dean)
def dashboard(request):
    """
    Dekan paneli ana sayfası.
    Bölüm, ders, öğretmen, öğrenci ekleme işlemleri tek bir sayfada yapılır.
    """
    dept_form = DepartmentForm()
    course_form = CourseForm()
    teacher_form = TeacherForm()
    student_form = StudentForm()

    # POST işlemleri
    if request.method == "POST":
        action = request.POST.get("action")

        if action == "create_department":
            dept_form = DepartmentForm(request.POST)
            if dept_form.is_valid():
                dept_form.save()
                messages.success(request, "Yeni bölüm başarıyla eklendi.")
                return redirect("dean:dashboard")

        elif action == "create_course":
            course_form = CourseForm(request.POST)
            if course_form.is_valid():
                course_form.save()
                messages.success(request, "Yeni ders başarıyla eklendi.")
                return redirect("dean:dashboard")

        elif action == "create_teacher":
            teacher_form = TeacherForm(request.POST)
            if teacher_form.is_valid():
                teacher_form.save()
                messages.success(request, "Yeni öğretmen başarıyla eklendi.")
                return redirect("dean:dashboard")

        elif action == "create_student":
            student_form = StudentForm(request.POST)
            if student_form.is_valid():
                student_form.save()
                messages.success(request, "Yeni öğrenci başarıyla eklendi.")
                return redirect("dean:dashboard")

        else:
            messages.error(request, "Geçersiz işlem türü!")

    # Listeler
    departments = Department.objects.all()
    courses = Course.objects.all()
    teachers = Teacher.objects.all()
    students = Student.objects.all()

    context = {
        "dept_form": dept_form,
        "course_form": course_form,
        "teacher_form": teacher_form,
        "student_form": student_form,
        "departments": departments,
        "courses": courses,
        "teachers": teachers,
        "students": students,
    }

    return render(request, "dean/dashboard.html", context)
